<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>RO msgstringtable.csv Editor</title>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body,
    html {
      height: 100%;
      background-color: #40444b;
      color: hsl(210, calc(1 * 9.1%), 87.1%);
    }
  
    .container {
      height: 100%;
      display: flex;
      flex-direction: column;
    }
  
    .input-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
  
    .table-container {
      flex: 1;
      overflow-y: auto;
    }
  
    input[type="file"],
    input[type="text"],
    input[type="button"],
    th {
      background-color: #40444b;
      color: hsl(210, calc(1 * 9.1%), 87.1%);
      border: 1px solid hsl(210, calc(1 * 9.1%), 87.1%);
    }
  </style>
</head>

<body>
  <div id="app" class="container">
    <h1>RO msgstringtable.csv Editor</h1>
    <div class="input-row">
      <div class="custom-file">
        <input type="file" ref="mainFileInput" class="custom-file-input" @change="handleFileUpload">
        <label class="custom-file-label">Load Main File</label>
      </div>

      <button @click="addRow" class="btn btn-primary">Add Row</button>
      <button @click="saveTableContent" class="btn btn-success">Save</button>

      <div class="custom-file">
        <input type="file" ref="replaceFileInput" class="custom-file-input" @change="replaceTextColumn">
        <label class="custom-file-label">Load File to Replace Text</label>
      </div>
    </div>

    <div class="table-container">
      <table class="table table-dark table-striped">
        <thead>
          <tr>
            <th>ID</th>
            <th>Text</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="(row, rowIndex) in tableData" :key="row.id">
            <td><input type="text" v-model="row.data[0]" class="form-control"></td>
            <td><input type="text" v-model="row.data[1]" class="form-control"></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
  <script>
    new Vue({
      el: '#app',
      data: {
        columns: ['ID', 'Text'],
        tableData: [],
        batchSize: 50,
        lastId: 0
      },
      methods: {
        addRow() {
          const newRow = {
            id: this.lastId++,
            data: Array(this.columns.length).fill('')
          };
          this.tableData.push(newRow);
        },
        handleFileUpload(event) {
          const file = event.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
              const content = e.target.result;
              let rows = content.split('\n').map(row => row.trim().split(','));

              if (rows[rows.length - 1].every(cell => cell === '')) {
                rows = rows.slice(0, -1);
              }

              this.tableData = rows.map((row) => {
                return {
                  id: this.lastId++,
                  data: row.map(cell => this.decodeCell(cell))
                };
              });
            };
            reader.readAsText(file);
          }
        },
        saveTableContent() {
          const content = this.tableData.map(row => row.data.map(cell => this.encodeCell(cell)).join(',')).join('\n');
          const blob = new Blob([content], { type: 'text/csv' });
          const link = document.createElement('a');
          link.href = window.URL.createObjectURL(blob);
          link.download = 'table_data.csv';
          link.click();
        },
        encodeCell(value) {
          return btoa(unescape(encodeURIComponent(value))); // Encode using multiple steps
        },
        decodeCell(value) {
          return decodeURIComponent(escape(atob(value))); // Decode using multiple steps
        },
        replaceTextColumn(event) {
          const file = event.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
              const content = e.target.result;
              let rows = content.split('\n').map(row => row.trim().split(','));

              if (rows[rows.length - 1].every(cell => cell === '')) {
                rows = rows.slice(0, -1);
              }

              this.tableData = this.tableData.map((row) => {
                const matchedRow = rows.find(newRow => {
                  const decodedID = this.decodeCell(newRow[0]);
                  return decodedID === row.data[0];
                });
                if (matchedRow) {
                  return {
                    ...row,
                    data: [row.data[0], this.decodeCell(matchedRow[1])]
                  };
                }
                return row;
              });
            };
            reader.readAsText(file);
          }
        },
      },
    });
  </script>
</body>

</html>
